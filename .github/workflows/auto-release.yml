name: Automated Release

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: 'patch'
      is_beta:
        description: 'Is this a beta release?'
        required: true
        type: boolean
        default: false

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node 20
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get current version
        id: current_version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build project
        run: npm run build

      - name: Bump version
        id: bump_version
        run: |
          if [ "${{ github.event.inputs.is_beta }}" == "true" ]; then
            NEW_VERSION=$(npm version prerelease --preid=beta --no-git-tag-version)
          else
            NEW_VERSION=$(npm version ${{ github.event.inputs.version_bump }} --no-git-tag-version)
          fi
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: Get version without v prefix
        id: clean_version
        run: |
          VERSION="${{ steps.bump_version.outputs.version }}"
          CLEAN_VERSION="${VERSION#v}"
          echo "version=$CLEAN_VERSION" >> $GITHUB_OUTPUT
          echo "Clean version: $CLEAN_VERSION"

      - name: Generate changelog
        id: changelog
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
          fi

          echo "## ðŸš€ What's Changed" > CHANGELOG.md
          echo "" >> CHANGELOG.md

          # Get commits grouped by type
          git log $PREVIOUS_TAG..HEAD --pretty=format:"%s|%an|%ae" --no-merges | while IFS='|' read -r subject author email; do
            case "$subject" in
              feat:*|feat\(*)
                echo "### âœ¨ Features" >> CHANGELOG_FEATURES.tmp
                echo "- $subject by @$author" >> CHANGELOG_FEATURES.tmp
                ;;
              fix:*)
                echo "### ðŸ› Bug Fixes" >> CHANGELOG_FIXES.tmp
                echo "- $subject by @$author" >> CHANGELOG_FIXES.tmp
                ;;
              docs:*)
                echo "### ðŸ“š Documentation" >> CHANGELOG_DOCS.tmp
                echo "- $subject by @$author" >> CHANGELOG_DOCS.tmp
                ;;
              perf:*)
                echo "### âš¡ Performance" >> CHANGELOG_PERF.tmp
                echo "- $subject by @$author" >> CHANGELOG_PERF.tmp
                ;;
              refactor:*)
                echo "### â™»ï¸ Refactoring" >> CHANGELOG_REFACTOR.tmp
                echo "- $subject by @$author" >> CHANGELOG_REFACTOR.tmp
                ;;
              test:*)
                echo "### ðŸ§ª Tests" >> CHANGELOG_TESTS.tmp
                echo "- $subject by @$author" >> CHANGELOG_TESTS.tmp
                ;;
              chore:*|build:*|ci:*)
                echo "### ðŸ”§ Chores & CI" >> CHANGELOG_CHORES.tmp
                echo "- $subject by @$author" >> CHANGELOG_CHORES.tmp
                ;;
              a11y:*)
                echo "### â™¿ Accessibility" >> CHANGELOG_A11Y.tmp
                echo "- $subject by @$author" >> CHANGELOG_A11Y.tmp
                ;;
              *)
                echo "### ðŸ”„ Other Changes" >> CHANGELOG_OTHER.tmp
                echo "- $subject by @$author" >> CHANGELOG_OTHER.tmp
                ;;
            esac
          done

          # Combine all sections
          [ -f CHANGELOG_FEATURES.tmp ] && cat CHANGELOG_FEATURES.tmp >> CHANGELOG.md && echo "" >> CHANGELOG.md
          [ -f CHANGELOG_FIXES.tmp ] && cat CHANGELOG_FIXES.tmp >> CHANGELOG.md && echo "" >> CHANGELOG.md
          [ -f CHANGELOG_A11Y.tmp ] && cat CHANGELOG_A11Y.tmp >> CHANGELOG.md && echo "" >> CHANGELOG.md
          [ -f CHANGELOG_PERF.tmp ] && cat CHANGELOG_PERF.tmp >> CHANGELOG.md && echo "" >> CHANGELOG.md
          [ -f CHANGELOG_DOCS.tmp ] && cat CHANGELOG_DOCS.tmp >> CHANGELOG.md && echo "" >> CHANGELOG.md
          [ -f CHANGELOG_REFACTOR.tmp ] && cat CHANGELOG_REFACTOR.tmp >> CHANGELOG.md && echo "" >> CHANGELOG.md
          [ -f CHANGELOG_TESTS.tmp ] && cat CHANGELOG_TESTS.tmp >> CHANGELOG.md && echo "" >> CHANGELOG.md
          [ -f CHANGELOG_CHORES.tmp ] && cat CHANGELOG_CHORES.tmp >> CHANGELOG.md && echo "" >> CHANGELOG.md
          [ -f CHANGELOG_OTHER.tmp ] && cat CHANGELOG_OTHER.tmp >> CHANGELOG.md && echo "" >> CHANGELOG.md

          # Get contributors
          echo "## ðŸ‘¥ Contributors" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          git log $PREVIOUS_TAG..HEAD --format='%an|%ae' --no-merges | sort -u | while IFS='|' read -r name email; do
            echo "- $name" >> CHANGELOG.md
          done

          # Get full comparison
          echo "" >> CHANGELOG.md
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$PREVIOUS_TAG...${{ steps.bump_version.outputs.version }}" >> CHANGELOG.md

          # Clean up temp files
          rm -f CHANGELOG_*.tmp

          # Output changelog for use in release
          cat CHANGELOG.md

      - name: Commit version bump
        run: |
          git add package.json package-lock.json
          git commit -m "chore: bump version from ${{ steps.current_version.outputs.version }} to ${{ steps.clean_version.outputs.version }}"

      - name: Create and push tag
        run: |
          git tag -a ${{ steps.bump_version.outputs.version }} -m "Release ${{ steps.bump_version.outputs.version }}"
          git push origin main
          git push origin ${{ steps.bump_version.outputs.version }}

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event.inputs.is_beta }}" == "true" ]; then
            gh release create ${{ steps.bump_version.outputs.version }} \
              --title "Release ${{ steps.bump_version.outputs.version }} (Beta)" \
              --notes-file CHANGELOG.md \
              --verify-tag \
              --prerelease
          else
            gh release create ${{ steps.bump_version.outputs.version }} \
              --title "Release ${{ steps.bump_version.outputs.version }}" \
              --notes-file CHANGELOG.md \
              --verify-tag
          fi

      - name: Publish to NPM
        run: |
          if [ "${{ github.event.inputs.is_beta }}" == "true" ]; then
            npm publish --tag beta
          else
            npm publish
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish to GitHub Packages
        run: |
          # Reconfigure for GitHub Packages
          npm config set registry https://npm.pkg.github.com
          npm config set //npm.pkg.github.com/:_authToken ${{ secrets.GITHUB_TOKEN }}

          if [ "${{ github.event.inputs.is_beta }}" == "true" ]; then
            npm publish --tag beta
          else
            npm publish
          fi

      - name: Create release summary
        run: |
          if [ "${{ github.event.inputs.is_beta }}" == "true" ]; then
            echo "## ðŸ§ª Beta Release ${{ steps.bump_version.outputs.version }} Published!" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ðŸŽ‰ Release ${{ steps.bump_version.outputs.version }} Published!" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Package Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.clean_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Previous Version**: ${{ steps.current_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.is_beta }}" == "true" ]; then
            echo "- **Release Type**: Beta (prerelease)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Bump Type**: ${{ github.event.inputs.version_bump }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.bump_version.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.is_beta }}" == "true" ]; then
            echo "- [NPM Package (beta)](https://www.npmjs.com/package/react-lite-youtube-embed/v/${{ steps.clean_version.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "- [NPM Package](https://www.npmjs.com/package/react-lite-youtube-embed/v/${{ steps.clean_version.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- [GitHub Packages](https://github.com/${{ github.repository }}/pkgs/npm/react-lite-youtube-embed)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat CHANGELOG.md >> $GITHUB_STEP_SUMMARY
