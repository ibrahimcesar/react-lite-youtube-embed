name: Automated Release

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - none
          - patch
          - minor
          - major
        default: 'patch'
      is_beta:
        description: 'Is this a beta release?'
        required: true
        type: boolean
        default: false

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
      packages: write
      id-token: write  # Required for SLSA provenance
      attestations: write  # Required for build attestations

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node 22
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get current version
        id: current_version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build project
        run: npm run build

      - name: Generate build attestation
        id: attest
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: 'dist/**/*'

      - name: Bump version
        id: bump_version
        run: |
          if [ "${{ github.event.inputs.version_bump }}" == "none" ]; then
            # No version bump - use current version for republishing
            CURRENT_VERSION=$(node -p "require('./package.json').version")
            NEW_VERSION="v$CURRENT_VERSION"
            echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "Republishing current version: $NEW_VERSION"
          elif [ "${{ github.event.inputs.is_beta }}" == "true" ]; then
            NEW_VERSION=$(npm version prerelease --preid=beta --no-git-tag-version)
            echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "New version: $NEW_VERSION"
          else
            NEW_VERSION=$(npm version ${{ github.event.inputs.version_bump }} --no-git-tag-version)
            echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "New version: $NEW_VERSION"
          fi

      - name: Get version without v prefix
        id: clean_version
        run: |
          VERSION="${{ steps.bump_version.outputs.version }}"
          CLEAN_VERSION="${VERSION#v}"
          echo "version=$CLEAN_VERSION" >> $GITHUB_OUTPUT
          echo "Clean version: $CLEAN_VERSION"

      - name: Generate changelog
        id: changelog
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
          fi

          echo "## ðŸš€ What's Changed" > CHANGELOG.md
          echo "" >> CHANGELOG.md

          # Get commits grouped by type
          git log $PREVIOUS_TAG..HEAD --pretty=format:"%s|%an|%ae" --no-merges | while IFS='|' read -r subject author email; do
            case "$subject" in
              feat:*|feat\(*)
                echo "### âœ¨ Features" >> CHANGELOG_FEATURES.tmp
                echo "- $subject by @$author" >> CHANGELOG_FEATURES.tmp
                ;;
              fix:*)
                echo "### ðŸ› Bug Fixes" >> CHANGELOG_FIXES.tmp
                echo "- $subject by @$author" >> CHANGELOG_FIXES.tmp
                ;;
              docs:*)
                echo "### ðŸ“š Documentation" >> CHANGELOG_DOCS.tmp
                echo "- $subject by @$author" >> CHANGELOG_DOCS.tmp
                ;;
              perf:*)
                echo "### âš¡ Performance" >> CHANGELOG_PERF.tmp
                echo "- $subject by @$author" >> CHANGELOG_PERF.tmp
                ;;
              refactor:*)
                echo "### â™»ï¸ Refactoring" >> CHANGELOG_REFACTOR.tmp
                echo "- $subject by @$author" >> CHANGELOG_REFACTOR.tmp
                ;;
              test:*)
                echo "### ðŸ§ª Tests" >> CHANGELOG_TESTS.tmp
                echo "- $subject by @$author" >> CHANGELOG_TESTS.tmp
                ;;
              chore:*|build:*|ci:*)
                echo "### ðŸ”§ Chores & CI" >> CHANGELOG_CHORES.tmp
                echo "- $subject by @$author" >> CHANGELOG_CHORES.tmp
                ;;
              a11y:*)
                echo "### â™¿ Accessibility" >> CHANGELOG_A11Y.tmp
                echo "- $subject by @$author" >> CHANGELOG_A11Y.tmp
                ;;
              *)
                echo "### ðŸ”„ Other Changes" >> CHANGELOG_OTHER.tmp
                echo "- $subject by @$author" >> CHANGELOG_OTHER.tmp
                ;;
            esac
          done

          # Combine all sections
          [ -f CHANGELOG_FEATURES.tmp ] && cat CHANGELOG_FEATURES.tmp >> CHANGELOG.md && echo "" >> CHANGELOG.md
          [ -f CHANGELOG_FIXES.tmp ] && cat CHANGELOG_FIXES.tmp >> CHANGELOG.md && echo "" >> CHANGELOG.md
          [ -f CHANGELOG_A11Y.tmp ] && cat CHANGELOG_A11Y.tmp >> CHANGELOG.md && echo "" >> CHANGELOG.md
          [ -f CHANGELOG_PERF.tmp ] && cat CHANGELOG_PERF.tmp >> CHANGELOG.md && echo "" >> CHANGELOG.md
          [ -f CHANGELOG_DOCS.tmp ] && cat CHANGELOG_DOCS.tmp >> CHANGELOG.md && echo "" >> CHANGELOG.md
          [ -f CHANGELOG_REFACTOR.tmp ] && cat CHANGELOG_REFACTOR.tmp >> CHANGELOG.md && echo "" >> CHANGELOG.md
          [ -f CHANGELOG_TESTS.tmp ] && cat CHANGELOG_TESTS.tmp >> CHANGELOG.md && echo "" >> CHANGELOG.md
          [ -f CHANGELOG_CHORES.tmp ] && cat CHANGELOG_CHORES.tmp >> CHANGELOG.md && echo "" >> CHANGELOG.md
          [ -f CHANGELOG_OTHER.tmp ] && cat CHANGELOG_OTHER.tmp >> CHANGELOG.md && echo "" >> CHANGELOG.md

          # Get contributors
          echo "## ðŸ‘¥ Contributors" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          git log $PREVIOUS_TAG..HEAD --format='%an|%ae' --no-merges | sort -u | while IFS='|' read -r name email; do
            echo "- $name" >> CHANGELOG.md
          done

          # Get full comparison
          echo "" >> CHANGELOG.md
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$PREVIOUS_TAG...${{ steps.bump_version.outputs.version }}" >> CHANGELOG.md

          # Clean up temp files
          rm -f CHANGELOG_*.tmp

          # Output changelog for use in release
          cat CHANGELOG.md

      - name: Commit version bump
        run: |
          if [ "${{ github.event.inputs.version_bump }}" != "none" ]; then
            git add package.json package-lock.json
            git commit -m "chore: bump version from ${{ steps.current_version.outputs.version }} to ${{ steps.clean_version.outputs.version }}"
          else
            echo "Skipping version bump commit (republishing current version)"
          fi

      - name: Create and push tag
        run: |
          TAG_NAME="${{ steps.bump_version.outputs.version }}"

          # Check if tag already exists locally
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "Tag $TAG_NAME already exists locally, deleting it"
            git tag -d "$TAG_NAME"
          fi

          # Check if tag exists on remote
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG_NAME"; then
            echo "Tag $TAG_NAME already exists on remote, deleting it"
            git push --delete origin "$TAG_NAME" || true
          fi

          # Create new tag
          git tag -a "$TAG_NAME" -m "Release $TAG_NAME"

          # Push changes
          if [ "${{ github.event.inputs.version_bump }}" != "none" ]; then
            git push origin main
          else
            echo "Skipping push to main (no version bump)"
          fi
          git push origin "$TAG_NAME"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ steps.bump_version.outputs.version }}"

          # Delete existing release if it exists
          if gh release view "$TAG_NAME" >/dev/null 2>&1; then
            echo "Release $TAG_NAME already exists, deleting it"
            gh release delete "$TAG_NAME" --yes --cleanup-tag || true
          fi

          # Create new release
          if [ "${{ github.event.inputs.is_beta }}" == "true" ]; then
            gh release create "$TAG_NAME" \
              --title "Release $TAG_NAME (Beta)" \
              --notes-file CHANGELOG.md \
              --verify-tag \
              --prerelease
          else
            gh release create "$TAG_NAME" \
              --title "Release $TAG_NAME" \
              --notes-file CHANGELOG.md \
              --verify-tag
          fi

      - name: Publish to NPM
        run: |
          # Configure npm for public registry
          npm config set registry https://registry.npmjs.org
          npm config set //registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}

          # Publish with provenance for SLSA attestation
          if [ "${{ github.event.inputs.is_beta }}" == "true" ]; then
            npm publish --tag beta --provenance
          else
            npm publish --provenance
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Setup Node for GitHub Packages
        uses: actions/setup-node@v6
        with:
          node-version: 22
          registry-url: 'https://npm.pkg.github.com'
          scope: '@ibrahimcesar'

      - name: Publish to GitHub Packages
        run: |
          # Configure npm for GitHub Packages registry
          npm config set registry https://npm.pkg.github.com
          npm config set //npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}

          # Publish with provenance (uses attestations generated above)
          if [ "${{ github.event.inputs.is_beta }}" == "true" ]; then
            npm publish --tag beta --provenance
          else
            npm publish --provenance
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create release summary
        run: |
          if [ "${{ github.event.inputs.is_beta }}" == "true" ]; then
            echo "## ðŸ§ª Beta Release ${{ steps.bump_version.outputs.version }} Published!" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ðŸŽ‰ Release ${{ steps.bump_version.outputs.version }} Published!" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Package Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.clean_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.version_bump }}" != "none" ]; then
            echo "- **Previous Version**: ${{ steps.current_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ github.event.inputs.is_beta }}" == "true" ]; then
            echo "- **Release Type**: Beta (prerelease)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ github.event.inputs.version_bump }}" == "none" ]; then
            echo "- **Release Type**: Republish (no version bump)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Bump Type**: ${{ github.event.inputs.version_bump }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.bump_version.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.is_beta }}" == "true" ]; then
            echo "- [NPM Package (beta)](https://www.npmjs.com/package/react-lite-youtube-embed/v/${{ steps.clean_version.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "- [NPM Package](https://www.npmjs.com/package/react-lite-youtube-embed/v/${{ steps.clean_version.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- [GitHub Packages](https://github.com/${{ github.repository }}/pkgs/npm/react-lite-youtube-embed)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat CHANGELOG.md >> $GITHUB_STEP_SUMMARY
